---
title: "R Notebook"
output: html_notebook
---


```{r message=FALSE}
library(knitr)
library(fpp3)
library(readxl)
library(httr)
library(glue)
#install.packages("corrr")
library(corrr)
library(slider)
library(forcats)
```


## Import Data
```{r}
df<-readr::read_csv('df_bike_summons_2023-06-25.csv')

df<-df %>% 
  mutate(VIOLATION_CODE = as.factor(VIOLATION_CODE)) %>%
  mutate(VEH_CATEGORY = as.factor(VEH_CATEGORY)) %>% 
  mutate(CITY_NM = as.factor(CITY_NM)) %>% 
  mutate(RPT_OWNING_CMD = as.factor(RPT_OWNING_CMD)) %>% 
  mutate(VIOLATION_DATE = as.POSIXct(VIOLATION_DATE)) 

head(df)
str(df)

# convert to tsibble and add daily totaly violations for easier gpaphing and ts analysis
ts_daily_total <- df %>% 
  mutate(VIOLATION_DATE = as_date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE, daily_total_cyclists) %>% 
  summarize(daily_total_violations = sum(n())) %>% 
  ungroup() %>% 
  as_tsibble(index = VIOLATION_DATE)

# test
df %>% 
  mutate(VIOLATION_DATE = as_date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE, daily_total_cyclists) %>% 
  summarize(daily_total_violations = sum(n())) %>% 
  ungroup() %>% 
  as_tsibble(index = VIOLATION_DATE)

ts_daily_total
```
## Clean tsibble
```{r}
# there are 29 missing days
ts_daily_total %>% 
  scan_gaps()

# fill gaps re-join with df_counts data, so that gapped dates now have total cyclsits. Fill na violation data with 0s.
ts_daily_total<-ts_daily_total %>%
  fill_gaps() %>%
  mutate(date = VIOLATION_DATE) %>% 
  left_join(y=df_counts, by='date', multiple='first') %>% 
  select(-c('counts', 'date', 'daily_total_cyclists', 'week_total')) %>% 
  rename('daily_total_cyclists' = 'day_total') %>% 
  mutate_at('daily_total_violations', ~replace_na(., 0)) 
```


# EDA

## General EDA

### Plot: daily total cyclists over time
```{r}
ts_daily_total %>% 
  autoplot(daily_total_cyclists)

# takeaway: ridership did not change much pre or post pandemic. not even during lockdown, although possible hickup.
```
### Plot: daily total cyclists histogram
```{r}
ts_daily_total %>% 
  ggplot(aes(x=daily_total_cyclists))+
  geom_histogram(bins=80)
```

### Daily total cyclists decomposition
```{r}

# classical decomp doesnt handle multi seasonality too well
ts_daily_total %>% 
  model(classical_decomposition(daily_total_cyclists, type = "additive"))%>%
	components() %>%
  autoplot()


# STL - best so far
ts_daily_total 	%>%
	model(
    STL(daily_total_cyclists ~ trend(window = 31) +
                   season(period = 'week')+season(period='year'),
    )) %>%
  components() %>% 
  autoplot()

# what about moving average for trend?  it ok.  I think stl is best.
ts_daily_total %>% 
    mutate(`5-MA` = slider::slide_dbl(daily_total_cyclists, mean, .before = 90, .after = 90, .complete = TRUE)) %>%
    autoplot(daily_total_cyclists)+
    geom_line(aes(y = `5-MA`), colour = "#D55E00")

# what about just a regular regression line
ts_daily_total %>% 
  autoplot(daily_total_cyclists)+
  stat_smooth(method = "lm")

str(ts_daily_total)
```



### Plot: daily total violations over time
```{r}

ts_daily_total %>% 
  autoplot(daily_total_violations)

# takeaway:  There were more violations before the pandemic.  During lockdown, very few.t.

```

### Plot: daily total violations historgram
```{r}
ts_daily_total %>% 
  ggplot(aes(x=daily_total_violations))+
  geom_histogram()
```



### What's the date range for the data? 
```{r}
date(range(df$VIOLATION_DATE))

```
### Which dates had the highest number of riders, and how many?
```{r}
df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  arrange(desc(daily_total_cyclists)) %>%
  distinct(VIOLATION_DATE, daily_total_cyclists) %>% 
  slice(1:10)

# takeaway: varied seasons.  Looks like mostly late summer / early autumn.  4 from September 2022.
```

### Which dates had the highest number of violations, and how many violations?
```{r}
df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE) %>% 
  summarize(daily_total_violations = sum(n())) %>% 
  arrange(desc(daily_total_violations)) %>% 
  slice(1:10)


# mostly warmer days in 2018 and 2019, pre-pandemic
```
### As the number of riders increases, does the number of violations also increase?
```{r}

# utilizes corrr library

df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE) %>% 
  mutate(daily_total_violations = sum(n())) %>% 
  select(daily_total_cyclists, daily_total_violations) %>% 
  correlate()

# takeaawy cor: 0.2159162 So no, as the number of riders increases, the number of violations does not. 

```
### Plot: daily violations vs. daily cylists
```{r}
ts_daily_total %>% 
  ggplot(aes(x=daily_total_violations, y=daily_total_cyclists))+
  geom_point()

```

### Does this differ for pre-covid and post-lockdown?
#### Plot: Pre-covid
```{r}

# pre-covid
ts_daily_total %>% 
  filter_index(~"2020-04") %>% 
  ggplot(aes(x=daily_total_violations, y=daily_total_cyclists))+
  geom_point()

# correlation:  0.501744
ts_daily_total %>% 
  filter_index(~"2020-04") %>% 
  select(daily_total_cyclists, daily_total_violations) %>% 
  correlate()

```

#### Plot: Post-covid
```{r}
# post-covid
ts_daily_total %>% 
  filter_index("2020-04"~.) %>% 
  ggplot(aes(x=daily_total_violations, y=daily_total_cyclists))+
  geom_point()

# correlation:  0.3846224
ts_daily_total %>% 
  filter_index("2020-04"~.) %>% 
  select(daily_total_cyclists, daily_total_violations) %>% 
  correlate()

# ans: they differ a little more than all together.  pre-covid was a better indicator.
```



## Violation codes EDA

### How many different violations were handed out to cyclist?
```{r}
df %>% 
  distinct(VIOLATION_CODE)
  
# ans: 184
```
### How many total violations were handed out to cyclists?
```{r}
length(df$VIOLATION_CODE)

# there were zero nas.  
#sum(is.na(df$VIOLATION_CODE))


# ans: 122620
```


### What were the most popular violations?

```{r}
df %>% 
  group_by(VIOLATION_CODE, DESCRIPTION) %>% 
  summarize(sum = sum(n())) %>% 
  arrange(desc(sum)) %>% 
  ungroup() %>% 
  slice(1:10)

str(df)
?summarize
```


#### scratchpad
```{r}
str(df)

# plot shows that ebikes and escooters didnt have their own categories until sometime in mid 2022. before that, everything was under 'bikes'
df %>% 
  ggplot(aes(x=VIOLATION_DATE, y=CITY_NM, col=VEH_CATEGORY))+
  geom_jitter()

#nuthin
df %>% 
  ggplot(aes(x=VIOLATION_DATE, y=CITY_NM, col=VIOLATION_CODE))+
  geom_jitter()

# violations per month
df %>% 
  group_by(yearmonth=yearmonth(VIOLATION_DATE)) %>% 
  summarize(total_violations =  sum(n())) %>% 
  ggplot(aes(x=yearmonth, y=total_violations))+
  geom_line()


# violations per borough per year
df %>% 
  group_by(year=yearmonth(VIOLATION_DATE), CITY_NM) %>% 
  summarize(total_violations =  sum(n())) %>% 
  ggplot(aes(x=year, y=total_violations, col=CITY_NM))+
  geom_line()


# cyclist counters per borough:
#library(forcats)
df_bicycle_counters_boroughs %>% 
  ggplot(aes(x=fct_infreq(Borough))) +
  geom_bar()+
  labs(x = "Borough", y="Cyclist Counters")
```


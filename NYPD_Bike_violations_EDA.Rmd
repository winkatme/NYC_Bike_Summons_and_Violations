---
title: "R Notebook"
output: html_notebook
---


```{r message=FALSE}
library(knitr)
library(fpp3)
library(readxl)
library(httr)
library(glue)
#install.packages("corrr")
library(corrr)
```

```{r}
df<-read.csv('df_bike_summons_2023-06-25.csv')

df<-df %>% 
  mutate(VIOLATION_CODE = as.factor(VIOLATION_CODE)) %>%
  mutate(VEH_CATEGORY = as.factor(VEH_CATEGORY)) %>% 
  mutate(CITY_NM = as.factor(CITY_NM)) %>% 
  mutate(RPT_OWNING_CMD = as.factor(RPT_OWNING_CMD)) %>% 
  mutate(VIOLATION_DATE = as.POSIXct(VIOLATION_DATE)) %>% 
  rename('daily_total_cyclists' = 'day_total') %>% 
  rename('weekly_total_cyclists' = 'week_total')
  
head(df)
str(df)
```


# EDA

## General EDA

### Plot: daily total riders over time
```{r}
# convert to tsibble and add daily totaly violations for easier gpaphing and ts analysis
ts_daily_total <- df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE, daily_total_cyclists) %>% 
  summarize(daily_total_violations = sum(n())) %>% 
  as_tsibble(index = VIOLATION_DATE)

head(ts_daily_total)

ts_daily_total %>% 
  autoplot(daily_total_cyclists)

# takeaway: ridership did not change much pre or post pandemic. not even during lockdown, although possible hickup.
```
### Plot: daily total violations over time
```{r}

ts_daily_total %>% 
  autoplot(daily_total_violations)

# takeaway:  There were more violations before the pandemic.  During lockdown, very few.t.

```


### What's the date range for the data? 
```{r}
date(range(df$VIOLATION_DATE))

```
### Which dates had the highest number of riders, and how many?
```{r}
df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  arrange(desc(daily_total_cyclists)) %>%
  distinct(VIOLATION_DATE, daily_total_cyclists) %>% 
  slice(1:10)

# takeaway: varied seasons.  Looks like mostly late summer / early autumn.  4 from September 2022.
```

### Which dates had the highest number of violations, and how many violations?
```{r}
df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE) %>% 
  summarize(daily_total_violations = sum(n())) %>% 
  arrange(desc(daily_total_violations)) %>% 
  slice(1:10)


# mostly warmer days in 2018 and 2019, pre-pandemic
```
### As the number of riders increases, does the number of violations also increase?
```{r}

# utilizes corrr library

df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE) %>% 
  mutate(daily_total_violations = sum(n())) %>% 
  select(daily_total_cyclists, daily_total_violations) %>% 
  correlate()

# takeaawy cor: 0.2159162 So no, as the number of riders increases, the number of violations does not. 

```
### Plot: daily violations vs. daily cylists
```{r}
df %>% 
  mutate(VIOLATION_DATE = date(VIOLATION_DATE)) %>% 
  group_by(VIOLATION_DATE) %>% 
  mutate(daily_total_violations = sum(n())) %>% 
  ggplot(aes(x=daily_total_violations, y=daily_total_cyclists))+
  geom_point()



```




## Violation codes EDA

### How many different violations were handed out to cyclist?
```{r}
df %>% 
  distinct(VIOLATION_CODE)
  
# ans: 184
```
### How many total violations were handed out to cyclists?
```{r}
length(df$VIOLATION_CODE)

# there were zero nas.  
#sum(is.na(df$VIOLATION_CODE))


# ans: 122620
```


### What were the most popular violations?

```{r}
df %>% 
  group_by(VIOLATION_CODE, DESCRIPTION) %>% 
  summarize(sum = sum(n())) %>% 
  arrange(desc(sum)) %>% 
  ungroup() %>% 
  slice(1:10)

str(df)
?summarize
```


